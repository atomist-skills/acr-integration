"use strict";
/*
 * Copyright Â© 2020 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.fetchGql = void 0;
const fs = require("fs-extra");
const path = require("path");
const graphql_1 = require("../graphql");
const log_1 = require("../log");
const skill_register_1 = require("./skill_register");
const IntrospectionQuery = `query IntrospectionQuery {
  __schema {
    queryType {
      name
    }
    mutationType {
      name
    }
    subscriptionType {
      name
    }
    types {
      ...FullType
    }
    directives {
      name
      description
      locations
      args {
        ...InputValue
      }
    }
  }
}

fragment FullType on __Type {
  kind
  name
  description
  fields(includeDeprecated: true) {
    name
    description
    args {
      ...InputValue
    }
    type {
      ...TypeRef
    }
    isDeprecated
    deprecationReason
  }
  inputFields {
    ...InputValue
  }
  interfaces {
    ...TypeRef
  }
  enumValues(includeDeprecated: true) {
    name
    description
    isDeprecated
    deprecationReason
  }
  possibleTypes {
    ...TypeRef
  }
}

fragment InputValue on __InputValue {
  name
  description
  type {
    ...TypeRef
  }
  defaultValue
}

fragment TypeRef on __Type {
  kind
  name
  ofType {
    kind
    name
    ofType {
      kind
      name
      ofType {
        kind
        name
        ofType {
          kind
          name
          ofType {
            kind
            name
            ofType {
              kind
              name
              ofType {
                kind
                name
              }
            }
          }
        }
      }
    }
  }
}
`;
async function fetchGql(cwd, workspaceId) {
    process.env.ATOMIST_LOG_LEVEL = "info";
    const w = await skill_register_1.wid(workspaceId);
    log_1.info(`Fetching GraphQL schema for workspace '${w}'`);
    const graphqlClient = graphql_1.createGraphQLClient(await skill_register_1.apiKey(), w);
    const schema = await graphqlClient.query(IntrospectionQuery);
    const schemaFile = path.join(cwd, "graphql", "schema.json");
    await fs.ensureDir(path.dirname(schemaFile));
    await fs.writeJson(schemaFile, schema, { spaces: 2 });
    log_1.info(`Written GraphQL schema to '${schemaFile}'`);
}
exports.fetchGql = fetchGql;
//# sourceMappingURL=gql_fetch.js.map